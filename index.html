<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MI TALLER MECÁNICO</title>
<style>
  :root {
    --bg: #0a0a0a;
    --panel: #0d1b2a;
    --accent: #00bcd4;
    --accent-hover: #0097a7;
    --text: #b0bec5;
    --border: #00bcd4;
  }
  * { box-sizing: border-box; }
  body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; }
  header { text-align: center; padding: 20px; background-color: var(--panel); }
  h1 { margin: 0; color: var(--accent); font-weight: 600; }
  main { padding: 20px; max-width: 960px; margin: auto; }
  input, select, textarea {
    background-color: var(--panel); border: 1px solid var(--border);
    color: #fff; padding: 10px; margin: 6px 0; width: 100%; border-radius: 6px;
  }
  textarea { min-height: 90px; resize: vertical; }
  button {
    background-color: var(--accent); border: none; padding: 9px 14px;
    color: #fff; cursor: pointer; margin: 6px 6px 6px 0; border-radius: 6px;
  }
  button:hover { background-color: var(--accent-hover); }
  .secondary { background: transparent; border: 1px solid var(--border); color: #fff; }
  .record { border: 1px solid var(--border); padding: 12px; margin: 12px 0; border-radius: 8px; background: rgba(13,27,42,0.5); }
  .kv { display: grid; grid-template-columns: 200px 1fr; gap: 6px 10px; align-items: start; }
  .kv b { color: #e0f7fa; font-weight: 600; }
  #menu {
    position: fixed; top: 0; left: 0; background-color: var(--panel);
    height: 100%; width: 280px; transform: translateX(-100%);
    transition: transform 0.3s ease; padding: 20px; box-shadow: 2px 0 12px rgba(0,0,0,0.4);
  }
  #menu.open { transform: translateX(0); }
  #menuToggle {
    position: fixed; top: 10px; left: 10px; background: none; border: 1px solid var(--border);
    font-size: 16px; color: var(--accent); cursor: pointer; padding: 6px 10px; border-radius: 6px;
  }
  .hidden { display: none; }
  .row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
  @media (max-width: 760px) { .row { grid-template-columns: 1fr; } #menu { width: 86vw; } }
  .hint { color: #8aa; font-size: 12px; margin: 8px 0 0; }
  .actions { margin-top: 8px; }
</style>
</head>
<body>

<button id="menuToggle">☰ Menú</button>
<aside id="menu" aria-label="Menú lateral">
  <h3 style="margin:0 0 10px;">Filtrar por campo</h3>
  <select id="filterField" title="Campo para filtrar"></select>
  <button id="viewAllBtn" style="margin-top:10px;">Ver registros ingresados</button>
  <p class="hint">El buscador muestra resultados mientras escribes. En vacío, no se muestran registros.</p>
  <hr style="border-color:#114; opacity:.3;">
  <p style="margin-top:14px;">Desarrollado por LPaz</p>
</aside>

<header>
  <h1>MI TALLER MECÁNICO</h1>
</header>

<main>
  <input type="text" id="search" placeholder="Buscar registro..." autocomplete="off" />
  <button id="newRecordBtn">Nuevo registro</button>
  <div id="formContainer" class="hidden"></div>
  <div id="results"></div>
</main>

<script>
(function(){
  // Persistencia
  const STORAGE_KEY = 'mitaller.registros.v1';
  let registros = loadFromStorage();

  // Configuración de campos
  const camposBase = ["Cliente","Trabajo","Fecha ingreso","Presupuesto total"];
  const camposExtra = [
    "RUT","Teléfono","Correo","Dirección","Marca","Modelo","Año","Patente","N° chasis/VIN",
    "Kilometraje","Color","Combustible","Transmisión","Repuestos","Descripción falla","Diagnóstico",
    "Trabajos a realizar","Costo repuestos","Costo mano de obra","Observaciones","Fecha entrega",
    "Estado trabajo","Abono","Saldo pendiente","Forma de pago","Fecha pago","Garantía","Notas internas"
  ];
  const camposMoneda = ["Presupuesto total","Costo repuestos","Costo mano de obra","Abono","Saldo pendiente"];

  // Elementos UI
  const menu = document.getElementById('menu');
  const menuToggle = document.getElementById('menuToggle');
  const filterField = document.getElementById('filterField');
  const viewAllBtn = document.getElementById('viewAllBtn');
  const newRecordBtn = document.getElementById('newRecordBtn');
  const search = document.getElementById('search');
  // Al hacer clic o enfocar el buscador, limpiar pantalla
search.onfocus = () => {
  results.innerHTML = '';
};
  const formContainer = document.getElementById('formContainer');
  const results = document.getElementById('results');

filterField.onchange = () => {
  const campo = filterField.value;
  if (!campo) return;

  let lista = [...registros];

  if (campo.toLowerCase().includes('fecha ingreso')) {
    // Ordenar fechas descendente
    lista.sort((a, b) => new Date(b[campo] || 0) - new Date(a[campo] || 0));
  } else if (!camposMoneda.includes(campo)) {
    // Ordenar alfabéticamente (ignorando mayúsculas/minúsculas)
    lista.sort((a, b) => {
      const va = (a[campo] || '').toString().toLowerCase();
      const vb = (b[campo] || '').toString().toLowerCase();
      return va.localeCompare(vb, 'es');
    });
  }
  // Si es campo monetario, no se ordena

  mostrarResultados(lista);
};

  // Eventos UI base
  menuToggle.onclick = () => menu.classList.toggle('open');
  viewAllBtn.onclick = () => mostrarResultados(registros);
  newRecordBtn.onclick = () => {
  results.innerHTML = ''; // Limpia la pantalla
  mostrarFormulario(camposBase, null);
};

  // Inicial
  actualizarFiltro();

  // Utilidades de almacenamiento
  function saveToStorage() { localStorage.setItem(STORAGE_KEY, JSON.stringify(registros)); }
  function loadFromStorage() {
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch { return []; }
  }

  // ID interno
  function createId() { return 'r_' + Date.now().toString(36) + Math.random().toString(36).slice(2,7); }

  // Formato CLP
  const formatCLP = val => {
    const n = Number(val);
    if (!isFinite(n)) return val ?? '';
    return new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 }).format(n);
  };

  // Determinar si un campo es largo (usa textarea)
  function isLongTextField(nombre) {
    const t = nombre.toLowerCase();
    return ['trabajos','descripción','diagnóstico','observaciones','notas'].some(s => t.includes(s));
  }

  // Construir formulario dinámico
  function mostrarFormulario(campos, id) {
    formContainer.innerHTML = '';
    const reg = id ? registros.find(x => x._id === id) : null;

    const grid = document.createElement('div');
    grid.className = 'row';

    campos.forEach(campo => {
      const wrap = document.createElement('div');
      const input = document.createElement(isLongTextField(campo) ? 'textarea' : 'input');
      input.placeholder = campo;
      input.dataset.campo = campo;

      if (input.tagName.toLowerCase() === 'input') {
        if (campo.toLowerCase().includes('fecha')) input.type = 'date';
        else if (camposMoneda.includes(campo)) {
          input.type = 'number';
          input.inputMode = 'numeric';
          input.oninput = () => { input.value = input.value.replace(/[^0-9]/g, ''); };
        } else input.type = 'text';
      }

      if (reg) input.value = reg[campo] || '';
      wrap.appendChild(input);
      grid.appendChild(wrap);
    });

    const actions = document.createElement('div');
    actions.className = 'actions';
    const saveBtn = document.createElement('button'); saveBtn.textContent = 'Guardar';
    const cancelBtn = document.createElement('button'); cancelBtn.textContent = 'Cancelar'; cancelBtn.className = 'secondary';

    saveBtn.onclick = () => {
      const target = reg || { _id: createId() };
      formContainer.querySelectorAll('input, textarea').forEach(inp => target[inp.dataset.campo] = inp.value);
      if (!reg) {
        registros.push(target);
        saveToStorage();
        mostrarResultados([target]); // Solo el nuevo
      } else {
        const idx = registros.findIndex(x => x._id === id);
        registros[idx] = target;
        saveToStorage();
        mostrarResultados(registros); // Edición: todos
      }
      formContainer.classList.add('hidden');
      actualizarFiltro();
    };

    cancelBtn.onclick = () => formContainer.classList.add('hidden');

    actions.appendChild(saveBtn);
    actions.appendChild(cancelBtn);

    formContainer.appendChild(grid);
    formContainer.appendChild(actions);
    formContainer.classList.remove('hidden');
  }

  // Agregar campos extra
  function elegirCamposExtra(id) {
    const reg = registros.find(x => x._id === id);
    formContainer.innerHTML = '<p>Seleccione campos adicionales:</p>';

    const disponibles = camposExtra.filter(c => !(c in reg));
    if (disponibles.length === 0) {
      const p = document.createElement('p');
      p.textContent = 'No hay campos disponibles para agregar.';
      formContainer.appendChild(p);
    } else {
      disponibles.forEach(campo => {
const line = document.createElement('div');
line.className = 'extra-field'; // Aplica el estilo que creamos
const chk = document.createElement('input');
chk.type = 'checkbox';
chk.value = campo;
chk.id = 'fld_' + campo;
const lbl = document.createElement('label');
lbl.textContent = campo;
lbl.htmlFor = chk.id;
line.appendChild(chk);
line.appendChild(lbl);
formContainer.appendChild(line);
      });
    }

    const actions = document.createElement('div');
    actions.className = 'actions';
    const addBtn = document.createElement('button'); addBtn.textContent = 'Agregar seleccionados';
    const backBtn = document.createElement('button'); backBtn.textContent = 'Volver atrás'; backBtn.className = 'secondary';

    addBtn.onclick = () => {
      const seleccionados = Array.from(formContainer.querySelectorAll('input[type=checkbox]:checked')).map(c => c.value);
      seleccionados.forEach(campo => reg[campo] = '');
      saveToStorage();
      mostrarFormulario(Object.keys(reg).filter(k => k !== '_id'), id);
    };

    backBtn.onclick = () => formContainer.classList.add('hidden');

    actions.appendChild(addBtn);
    actions.appendChild(backBtn);
    formContainer.appendChild(actions);
    formContainer.classList.remove('hidden');
  }

  // Render de resultados
  function mostrarResultados(lista) {
    results.innerHTML = '';
    if (!lista || lista.length === 0) {
      results.innerHTML = '<p>No hay registros para mostrar.</p>';
      return;
    }

    lista.forEach(reg => {
      const card = document.createElement('div');
      card.className = 'record';

      const kv = document.createElement('div');
      kv.className = 'kv';

      Object.entries(reg).forEach(([k, v]) => {
        if (k === '_id') return; // ocultar id interno
        const keyEl = document.createElement('b');
        keyEl.textContent = k + ':';
        const valEl = document.createElement('div');
        const isMoney = camposMoneda.includes(k);
        valEl.textContent = isMoney ? formatCLP(v) : (v ?? '');
        kv.appendChild(keyEl);
        kv.appendChild(valEl);
      });

      const actions = document.createElement('div');
      actions.className = 'actions';
      const editBtn = document.createElement('button'); editBtn.textContent = 'Editar';
      const delBtn = document.createElement('button'); delBtn.textContent = 'Eliminar';
      const addFieldBtn = document.createElement('button'); addFieldBtn.textContent = 'Incluir nuevos campos';
      const cancelBtn = document.createElement('button'); cancelBtn.textContent = 'Cancelar'; cancelBtn.className = 'secondary';

      editBtn.onclick = () => mostrarFormulario(Object.keys(reg).filter(k => k !== '_id'), reg._id);
      delBtn.onclick = () => {
        if (!confirm('¿Eliminar este registro?')) return;
        registros = registros.filter(x => x._id !== reg._id);
        saveToStorage();
        const q = search.value.trim().toLowerCase();
        if (q) doLiveSearch(q); else mostrarResultados(registros);
        actualizarFiltro();
      };
      addFieldBtn.onclick = () => elegirCamposExtra(reg._id);
      cancelBtn.onclick = () => { results.innerHTML = ''; };

      actions.appendChild(editBtn);
      actions.appendChild(delBtn);
      actions.appendChild(addFieldBtn);
      actions.appendChild(cancelBtn);

      card.appendChild(kv);
      card.appendChild(document.createElement('br'));
      card.appendChild(actions);
      results.appendChild(card);
    });
  }

  // Búsqueda en vivo (pantalla principal vacía si no hay término)
  function doLiveSearch(term) {
    if (registros.length === 0) { results.innerHTML = '<p>No hay registros.</p>'; return; }
    const filtered = registros.filter(r =>
      Object.entries(r)
        .filter(([k]) => k !== '_id')
        .some(([, val]) => (val ?? '').toString().toLowerCase().includes(term))
    );
    mostrarResultados(filtered);
  }

  search.oninput = e => {
    const term = e.target.value.toLowerCase().trim();
    if (!term) { results.innerHTML = ''; return; }
    doLiveSearch(term);
  };

  // Poblar selector de filtro con campos de todos los registros (por ahora solo informativo)
  function actualizarFiltro() {
    filterField.innerHTML = '';
    const campos = new Set();
    registros.forEach(r => Object.keys(r).forEach(k => { if (k !== '_id') campos.add(k); }));
    [...campos].sort().forEach(c => {
      const opt = document.createElement('option');
      opt.value = c;
      opt.textContent = c;
      filterField.appendChild(opt);
    });
  }
})();
</script>
</body>
</html>
